<link rel="import" href="chart-import.html">
<link rel="import" href="../polymer/polymer.html">

<!--
Element for creating charts

##### Example

    <app-chart type="line"></app-chart>

@element app-chart
@blurb Element for creating charts
@status alpha
@homepage http://the-control-group.github.io/app-chart
-->
<polymer-element name="app-chart" attributes="type repsonsive">

  <template>
    <link rel="stylesheet" href="app-chart.css" />
    <link type="text/css" rel="stylesheet" href="../rickshaw/src/css/graph.css">
    <link type="text/css" rel="stylesheet" href="../rickshaw/src/css/detail.css">
    <link type="text/css" rel="stylesheet" href="../rickshaw/src/css/legend.css">
    <content id="series" select="app-chart-series"></content>


    <div id="chart_container">
      <div id="y_axis"></div>
      <div id="chartEl"></div>
      <div id="x_axis"></div>
      <div id="legend"></div>
    </div>


  </template>

  <script>

    function merge(obj1,obj2){
        var obj3 = {};
        for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
        for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
        return obj3;
    }

    Polymer('app-chart', {
      /**
       * type of renderer for the chart
       *
       *  __renderers available__
       *  - stack
       *  - line
       *  - scatterplot
       *
       * @attribute type
       * @type String
       * @default ''
       */

      publish: {
        /**
         * this chart should be responsive to window size
         *
         * @attribute responsive
         * @type Boolean
         * @default ''
         */
        responsive: {
          value: false,
          reflect: true
        },
        /**
         * the chart series data
         *
         * @attribute series
         * @type Array
         * @default []
         */
        series:  [],
      },

      ready: function(){
        this.series = [];
        this.chart = null;
        if(this.responsive){
          window.addEventListener('resize', this.updateSize.bind(this));
        }
      },

      domReady: function(){
        this.async(this.updateDataSets.bind(this));
      },

      setup: function(){
        if(!this.chart){
          this.chart = new Rickshaw.Graph({
            element: this.$.chartEl,
            width: this.responsive ? this.clientWidth : (this.width || 400),
            height: this.responsive ? this.clientHeight : (this.height || 350),
            renderer: this.type || 'stack',
            series: this.series
          });
        } else {
          this.chart.series = this.series;
        }

        this.chart.render();
      },

      updateSize: function(){
        var dims = {};
        dims.width = this.clientWidth;
        dims.height = this.clientHeight;

        this.chart.setSize(dims);
        this.chart.update();
      },

      updateDataSets: function(){
        this.series = this.$.series.getDistributedNodes().array();

        this.onMutation(this, this.updateDataSets);

        this.series.forEach((function(dataset, k){
          var newData = {};
          newData.name = dataset.name;
          newData.color = dataset.color;
          newData.data = dataset.data;
          this.series[k] = newData;
        }).bind(this))

        // console.log(this.series)
        this.setup();
      }
    });

  </script>

</polymer-element>

<!--
The `app-chart-series` element represents a series of data.
It is used as a child of `app-chart`

##### Example

    <app-chart type="line">
      <app-chart-series name="MySeries">
        // data goes here
      </app-chart-series>
    </app-chart>

@element app-chart-series
@status alpha
@homepage http://the-control-group.github.io/app-chart
-->
<polymer-element name="app-chart-series" attributes="name color">
  <template>
    <content id="dataset" select="app-chart-data"></content>
  </template>
  <script>
  Polymer('app-chart-series', {
    /**
     * name of the series
     *
     * @attribute name
     * @type String
     * @default ''
     */

    /**
     * color of the series
     *
     * @attribute color
     * @type String
     * @default ''
     */

    attached: function(){
      this.async(this.updateDataSet.bind(this));
    },

    updateDataSet: function(){
      this.data = Array.prototype.slice.call(this.$.dataset.getDistributedNodes());

      this.data.forEach((function(item, k){
        var newData = {};
        newData.x = item.x,
        newData.y = item.y
        this.data[k] = newData;
      }).bind(this))

      this.onMutation(this, this.updateDataSet);
    }
  })
  </script>
</polymer-element>

<!--
The `app-chart-data` element represents a point of data.
It is used as a child of `app-chart-series`

##### Example

    <app-chart type="line">
      <app-chart-series name="MySeries">
        <app-chart-data x="1902" y="12313141"></app-chart-data>
      </app-chart-series>
    </app-chart>

@element app-chart-data
@status alpha
@homepage http://the-control-group.github.io/app-chart
-->
<polymer-element name="app-chart-data" attributes="x y message">
  <script>
  Polymer('app-chart-data', {
    publish: {
      /**
       * x value for the data
       *
       * @attribute x
       * @type Number
       * @default 0
       */
      x: 0,

      /**
       * y value for the data
       *
       * @attribute y
       * @type Number
       * @default 0
       */
      y: 0,

      /**
       * message to annotate the data with.
       *
       * @attribute message
       * @type String
       * @default ''
       */
      message: null
    }
  })
  </script>
</polymer-element>
